import os
import sys
import asyncio
import re
from typing import List, Tuple

# âš ï¸ [ìˆ˜ì •ëœ ë¶€ë¶„]: ìŠ¤í¬ë¦½íŠ¸ê°€ 'app' ë””ë ‰í† ë¦¬ ë°–ì— ìˆìœ¼ë¯€ë¡œ,
# 'app' ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ìˆë„ë¡ í”„ë¡œì íŠ¸ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ ê²€ìƒ‰ ê²½ë¡œì— ì¶”ê°€í•©ë‹ˆë‹¤.
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

# SQLAlchemy ë¹„ë™ê¸° ì»´í¬ë„ŒíŠ¸ ì„í¬íŠ¸
from sqlalchemy.ext.asyncio import create_async_engine
from app.database import AsyncSessionLocal, engine, Base # engine, Base, AsyncSessionLocalì´ í•„ìš”í•©ë‹ˆë‹¤.
from app.models import Subsidy # Subsidy ëª¨ë¸ ì„í¬íŠ¸
from app.config import settings

# --- ì—…ë°ì´íŠ¸ëœ RAW_SUBSIDY_DATA (ì œì¡°ì‚¬, ëª¨ë¸ëª…, êµ­ë¹„, ì§€ë°©ë¹„, ì´ë³´ì¡°ê¸ˆ - ë‹¨ìœ„: ë§Œì›) ---
RAW_SUBSIDY_DATA: List[Tuple[str, str, int, int, int]] = [
    ("í˜„ëŒ€ìë™ì°¨", "GV60 ìŠ¤íƒ ë‹¤ë“œ 2WD 19ì¸ì¹˜", 287, 148, 435),
    ("í˜„ëŒ€ìë™ì°¨", "GV60 ìŠ¤íƒ ë‹¤ë“œ AWD 19ì¸ì¹˜", 261, 135, 396),
    ("í˜„ëŒ€ìë™ì°¨", "GV60 ìŠ¤íƒ ë‹¤ë“œ AWD 20ì¸ì¹˜", 251, 129, 380),
    ("í˜„ëŒ€ìë™ì°¨", "GV60 í¼í¬ë¨¼ìŠ¤ AWD 21ì¸ì¹˜", 236, 122, 358),
    ("í˜„ëŒ€ìë™ì°¨", "Electrified GV70 AWD 20ì¸ì¹˜", 244, 126, 370),
    ("í˜„ëŒ€ìë™ì°¨", "Electrified GV70 AWD 19ì¸ì¹˜", 260, 134, 394),
    ("í˜„ëŒ€ìë™ì°¨", "ì•„ì´ì˜¤ë‹‰6 ìŠ¤íƒ ë‹¤ë“œ 2WD 18ì¸ì¹˜", 635, 272, 907),
    ("í˜„ëŒ€ìë™ì°¨", "ì•„ì´ì˜¤ë‹‰6 ë¡±ë ˆì¸ì§€ 2WD 18ì¸ì¹˜", 686, 297, 983),
    ("í˜„ëŒ€ìë™ì°¨", "ì•„ì´ì˜¤ë‹‰6 ë¡±ë ˆì¸ì§€ 2WD 20ì¸ì¹˜", 680, 294, 974),
    ("í˜„ëŒ€ìë™ì°¨", "ì•„ì´ì˜¤ë‹‰6 ë¡±ë ˆì¸ì§€ AWD 18ì¸ì¹˜", 686, 297, 983),
    ("í˜„ëŒ€ìë™ì°¨", "ì•„ì´ì˜¤ë‹‰6 ë¡±ë ˆì¸ì§€ AWD 20ì¸ì¹˜", 647, 277, 924),
    ("í˜„ëŒ€ìë™ì°¨", "ì½”ë‚˜ ì¼ë ‰íŠ¸ë¦­ 2WD ìŠ¤íƒ ë‹¤ë“œ 17ì¸ì¹˜", 573, 231, 804),
    ("í˜„ëŒ€ìë™ì°¨", "ì½”ë‚˜ ì¼ë ‰íŠ¸ë¦­ 2WD ë¡±ë ˆì¸ì§€ 17ì¸ì¹˜", 623, 271, 894),
    ("í˜„ëŒ€ìë™ì°¨", "ì½”ë‚˜ ì¼ë ‰íŠ¸ë¦­ 2WD ë¡±ë ˆì¸ì§€ 19ì¸ì¹˜(ë¹ŒíŠ¸ì¸ ìº )", 568, 242, 810),
    ("í˜„ëŒ€ìë™ì°¨", "ì•„ì´ì˜¤ë‹‰5 N", 232, 120, 352),
    ("í˜„ëŒ€ìë™ì°¨", "ë”ë‰´ì•„ì´ì˜¤ë‹‰5 2WD ë¡±ë ˆì¸ì§€ 19ì¸ì¹˜ ë¹ŒíŠ¸ì¸ ìº  ë¯¸ì ìš©", 659, 298, 957),
    ("í˜„ëŒ€ìë™ì°¨", "ë”ë‰´ì•„ì´ì˜¤ë‹‰5 2WD ë¡±ë ˆì¸ì§€ 19ì¸ì¹˜", 656, 296, 952),
    ("í˜„ëŒ€ìë™ì°¨", "ë”ë‰´ì•„ì´ì˜¤ë‹‰5 2WD ë¡±ë ˆì¸ì§€ 20ì¸ì¹˜", 651, 294, 945),
    ("í˜„ëŒ€ìë™ì°¨", "ë”ë‰´ì•„ì´ì˜¤ë‹‰5 AWD ë¡±ë ˆì¸ì§€ 20ì¸ì¹˜", 624, 280, 904),
    ("í˜„ëŒ€ìë™ì°¨", "ë”ë‰´ì•„ì´ì˜¤ë‹‰5 AWD ë¡±ë ˆì¸ì§€ 19ì¸ì¹˜", 650, 293, 943),
    ("í˜„ëŒ€ìë™ì°¨", "ë”ë‰´ì•„ì´ì˜¤ë‹‰5 2WD ë¡±ë ˆì¸ì§€ Në¼ì¸ 20ì¸ì¹˜", 633, 285, 918),
    ("í˜„ëŒ€ìë™ì°¨", "ë”ë‰´ì•„ì´ì˜¤ë‹‰5 AWD ë¡±ë ˆì¸ì§€ Në¼ì¸ 20ì¸ì¹˜", 602, 268, 870),
    ("í˜„ëŒ€ìë™ì°¨", "Electrified G80 AWD 19ì¸ì¹˜(2025)", 275, 142, 417),
    ("í˜„ëŒ€ìë™ì°¨", "ë”ë‰´ì•„ì´ì˜¤ë‹‰5 2WD ìŠ¤íƒ ë‹¤ë“œ 19ì¸ì¹˜", 561, 255, 816),
    ("í˜„ëŒ€ìë™ì°¨", "Electrified GV70 AWD 20ì¸ì¹˜(2025)", 250, 129, 379),
    ("í˜„ëŒ€ìë™ì°¨", "Electrified GV70 AWD 19ì¸ì¹˜(2025)", 266, 137, 403),
    ("í˜„ëŒ€ìë™ì°¨", "ì½”ë‚˜ ì¼ë ‰íŠ¸ë¦­ 2WD ë¡±ë ˆì¸ì§€ 17ì¸ì¹˜(ë¹ŒíŠ¸ì¸ ìº )", 623, 271, 894),
    ("í˜„ëŒ€ìë™ì°¨", "ì•„ì´ì˜¤ë‹‰9 ì„±ëŠ¥í˜• AWD", 277, 143, 420),
    ("í˜„ëŒ€ìë™ì°¨", "ì•„ì´ì˜¤ë‹‰9 í•­ì†í˜• AWD", 276, 142, 418),
    ("í˜„ëŒ€ìë™ì°¨", "ì•„ì´ì˜¤ë‹‰9 í•­ì†í˜• 2WD", 279, 144, 423),
    ("í˜„ëŒ€ìë™ì°¨", "GV60 í¼í¬ë¨¼ìŠ¤ AWD 21ì¸ì¹˜(2025)", 248, 128, 376),
    ("í˜„ëŒ€ìë™ì°¨", "GV60 ìŠ¤íƒ ë‹¤ë“œ AWD 20ì¸ì¹˜(2025)", 266, 137, 403),
    ("í˜„ëŒ€ìë™ì°¨", "GV60 ìŠ¤íƒ ë‹¤ë“œ AWD 19ì¸ì¹˜(2025)", 277, 143, 420),
    ("í˜„ëŒ€ìë™ì°¨", "GV60 ìŠ¤íƒ ë‹¤ë“œ 2WD 19ì¸ì¹˜(2025)", 290, 150, 440),
    ("í˜„ëŒ€ìë™ì°¨", "ë” ë‰´ ì•„ì´ì˜¤ë‹‰6 2wd ë¡±ë ˆì¸ì§€ në¼ì¸ 20ì¸ì¹˜", 580, 300, 880),
    ("í˜„ëŒ€ìë™ì°¨", "ë” ë‰´ ì•„ì´ì˜¤ë‹‰6 awd ë¡±ë ˆì¸ì§€ në¼ì¸ 20ì¸ì¹˜", 547, 282, 829),
    ("í˜„ëŒ€ìë™ì°¨", "ë” ë‰´ ì•„ì´ì˜¤ë‹‰6 2wd ë¡±ë ˆì¸ì§€ 18ì¸ì¹˜", 580, 300, 880),
    ("í˜„ëŒ€ìë™ì°¨", "ë” ë‰´ ì•„ì´ì˜¤ë‹‰6 2wd ë¡±ë ˆì¸ì§€ 20ì¸ì¹˜", 580, 300, 880),
    ("í˜„ëŒ€ìë™ì°¨", "ë” ë‰´ ì•„ì´ì˜¤ë‹‰6 awd ë¡±ë ˆì¸ì§€ 18ì¸ì¹˜", 580, 300, 880),
    ("í˜„ëŒ€ìë™ì°¨", "ë” ë‰´ ì•„ì´ì˜¤ë‹‰6 awd ë¡±ë ˆì¸ì§€ 20ì¸ì¹˜", 563, 291, 854),
    ("í˜„ëŒ€ìë™ì°¨", "ë” ë‰´ ì•„ì´ì˜¤ë‹‰6 2wd ìŠ¤íƒ ë‹¤ë“œ 18ì¸ì¹˜", 570, 294, 864),
    ("ê¸°ì•„", "The all-new Kia Niro EV", 590, 258, 848),
    ("ê¸°ì•„", "EV9 ë¡±ë ˆì¸ì§€ 2WD 19ì¸ì¹˜", 275, 142, 417),
    ("ê¸°ì•„", "EV9 ë¡±ë ˆì¸ì§€ 2WD 20ì¸ì¹˜", 273, 141, 414),
    ("ê¸°ì•„", "EV9 ë¡±ë ˆì¸ì§€ 4WD 19ì¸ì¹˜", 259, 133, 392),
    ("ê¸°ì•„", "EV9 ë¡±ë ˆì¸ì§€ 4WD 21ì¸ì¹˜", 265, 137, 402),
    ("ê¸°ì•„", "EV9 ë¡±ë ˆì¸ì§€ GTL 4WD 21ì¸ì¹˜", 257, 132, 389),
    ("ê¸°ì•„", "ë”ë‰´EV6 ë¡±ë ˆì¸ì§€ 4WD 20ì¸ì¹˜", 617, 280, 897),
    ("ê¸°ì•„", "ë”ë‰´EV6 ë¡±ë ˆì¸ì§€ 2WD 20ì¸ì¹˜", 644, 294, 938),
    ("ê¸°ì•„", "ë”ë‰´EV6 ë¡±ë ˆì¸ì§€ 4WD 19ì¸ì¹˜", 646, 295, 941),
    ("ê¸°ì•„", "ë”ë‰´EV6 ë¡±ë ˆì¸ì§€ 2WD 19ì¸ì¹˜", 655, 300, 955),
    ("ê¸°ì•„", "EV3 ë¡±ë ˆì¸ì§€ 2WD 17ì¸ì¹˜", 565, 292, 857),
    ("ê¸°ì•„", "EV3 ë¡±ë ˆì¸ì§€ 2WD 19ì¸ì¹˜", 565, 292, 857),
    ("ê¸°ì•„", "EV3 ìŠ¤íƒ ë‹¤ë“œ 2WD", 479, 247, 726),
    ("ê¸°ì•„", "ë”ë‰´EV6 GT", 232, 120, 352),
    ("ê¸°ì•„", "ë”ë‰´EV6 ìŠ¤íƒ ë‹¤ë“œ", 582, 264, 846),
    ("ê¸°ì•„", "EV9 ìŠ¤íƒ ë‹¤ë“œ", 242, 125, 367),
    ("ê¸°ì•„", "EV4 ë¡±ë ˆì¸ì§€ GTL 2WD 19ì¸ì¹˜", 565, 292, 857),
    ("ê¸°ì•„", "EV4 ìŠ¤íƒ ë‹¤ë“œ 2WD 19ì¸ì¹˜", 491, 253, 744),
    ("ê¸°ì•„", "EV4 ë¡±ë ˆì¸ì§€ 2WD 17ì¸ì¹˜", 565, 292, 857),
    ("ê¸°ì•„", "EV4 ë¡±ë ˆì¸ì§€ 2WD 19ì¸ì¹˜", 565, 292, 857),
    ("ê¸°ì•„", "EV4 ìŠ¤íƒ ë‹¤ë“œ 2WD 17ì¸ì¹˜", 522, 270, 792),
    ("ê¸°ì•„", "PV5 íŒ¨ì‹ ì € 5ì¸ìŠ¹ ë¡±ë ˆì¸ì§€", 468, 242, 710),
    ("ê¸°ì•„", "EV5 ë¡±ë ˆì¸ì§€ 2WD", 562, 290, 852),
    ("ë¥´ë…¸ì½”ë¦¬ì•„", "scenic", 443, 229, 672),
    ("BMW", "MINI Cooper SE", 303, 156, 459),
    ("BMW", "i4 eDrive40", 189, 97, 286),
    ("BMW", "i4 M50", 172, 88, 260),
    ("BMW", "iX1 xDrive30", 154, 79, 233),
    ("BMW", "i4 eDrive40 LCI", 187, 96, 283),
    ("BMW", "iX2 eDrive20", 167, 86, 253),
    ("BMW", "MINI Countryman SE ALL4", 158, 81, 239),
    ("BMW", "MINI Countryman E", 166, 85, 251),
    ("BMW", "MINI Aceman SE", 306, 158, 464),
    ("BMW", "i4 M50 LCI", 177, 91, 268),
    ("BMW", "MINI JCW Aceman E", 151, 78, 229),
    ("BMW", "MINI JCW E", 147, 76, 223),
    ("BMW", "MINI Aceman E", 306, 158, 464),
    ("BMW", "ix1 edrive20", 166, 85, 251),
    ("BMW", "i5 edrive 40", 198, 102, 300),
    ("í…ŒìŠ¬ë¼ì½”ë¦¬ì•„", "(ë‹¨ì¢…)Model 3 RWD(2024)", 183, 94, 277),
    ("í…ŒìŠ¬ë¼ì½”ë¦¬ì•„", "Model 3 Long Range", 202, 104, 306),
    ("í…ŒìŠ¬ë¼ì½”ë¦¬ì•„", "(ë‹¨ì¢…)Model Y RWD", 201, 87, 288),
    ("í…ŒìŠ¬ë¼ì½”ë¦¬ì•„", "(ë‹¨ì¢…)Model Y Long Range", 184, 95, 279),
    ("í…ŒìŠ¬ë¼ì½”ë¦¬ì•„", "(ë‹¨ì¢…)Model Y Performance", 191, 98, 289),
    ("í…ŒìŠ¬ë¼ì½”ë¦¬ì•„", "Model 3 Performance", 187, 96, 283),
    ("í…ŒìŠ¬ë¼ì½”ë¦¬ì•„", "(ë‹¨ì¢…)Model Y Long Range 19ì¸ì¹˜", 202, 104, 306),
    ("í…ŒìŠ¬ë¼ì½”ë¦¬ì•„", "Model 3 RWD", 186, 96, 282),
    ("í…ŒìŠ¬ë¼ì½”ë¦¬ì•„", "New Model Y Long Range", 207, 107, 314),
    ("í…ŒìŠ¬ë¼ì½”ë¦¬ì•„", "New Model Y RWD", 188, 97, 285),
    ("ë©”ë¥´ì„¸ë°ìŠ¤ë²¤ì¸ ì½”ë¦¬ì•„", "(ë‹¨ì¢…)EQB300 4MATIC(Pre-Facelift)(5ì¸ìŠ¹)", 152, 78, 230)
]

def extract_model_group(model_name: str) -> str:
    """
    ì„¸ë¶€ ëª¨ë¸ëª…ì—ì„œ ëª¨ë¸ ê·¸ë£¹ ì´ë¦„(ì˜ˆ: 'GV60' ë˜ëŠ” 'EV6')ì„ ì¶”ì¶œí•©ë‹ˆë‹¤.
    (ì²« ë²ˆì§¸ ê³µë°± ë˜ëŠ” ìˆ«ìê°€ ë‚˜ì˜¤ê¸° ì „ê¹Œì§€ì˜ ë¬¸ìì—´ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.)
    """
    # ìˆ«ì(0-9) ë˜ëŠ” ê³µë°±ì„ ì°¾ì•„ì„œ ê·¸ ì•ë¶€ë¶„ì„ ê·¸ë£¹ìœ¼ë¡œ ì¶”ì¶œ
    match = re.match(r"([^\s\d]+)", model_name)
    if match:
        return match.group(1).upper() # ëŒ€ë¬¸ìë¡œ ë³€í™˜í•˜ì—¬ ì¼ê´€ì„± ìœ ì§€

    # ì˜ˆì™¸: Model 3ì²˜ëŸ¼ ê³µë°± ì—†ì´ ìˆ«ìê°€ ë°”ë¡œ ë¶™ëŠ” ê²½ìš°, ë˜ëŠ” ì´ë¦„ì— ìˆ«ìê°€ í¬í•¨ëœ ê²½ìš°
    # ex) ì•„ì´ì˜¤ë‹‰5 -> ì•„ì´ì˜¤ë‹‰5 / Model 3 -> Model
    # ì—¬ê¸°ì„œëŠ” ì¢€ ë” ì •êµí•˜ê²Œ ì²« ë²ˆì§¸ ê³µë°±ê¹Œì§€ë§Œ ì‚¬ìš©í•˜ê±°ë‚˜, íŠ¹ë³„ ì¼€ì´ìŠ¤ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
    if " " in model_name:
        first_word = model_name.split(" ")[0]
        # ì•„ì´ì˜¤ë‹‰5, Model 3 ë“± ìˆ«ìì™€ ì´ë¦„ì´ ë¶™ì–´ìˆëŠ” ê²½ìš° ì²˜ë¦¬
        if re.match(r"[A-Za-z]+[0-9]+", first_word) and not re.match(r"[0-9]", first_word):
            return first_word.upper()

    return model_name.split(" ")[0].upper() # ê¸°ë³¸ì ìœ¼ë¡œ ì²« ë²ˆì§¸ ë‹¨ì–´ë¥¼ ì‚¬ìš©

async def initialize_subsidy_data():
    """
    DBì— ë³´ì¡°ê¸ˆ ì´ˆê¸° ë°ì´í„°ë¥¼ ëŒ€ëŸ‰ ì‚½ì…í•©ë‹ˆë‹¤.
    """
    # âš ï¸ ì¤‘ìš”: init_db() í˜¸ì¶œí•˜ì—¬ Subsidy í…Œì´ë¸”ì´ í™•ì‹¤íˆ ì¡´ì¬í•˜ë„ë¡ ë³´ì¥
    try:
        print("INFO: DB í…Œì´ë¸” ìƒì„± í™•ì¸/ì´ˆê¸°í™” ì¤‘...")
        async with engine.begin() as conn:
            # Base.metadataì— ë“±ë¡ëœ ëª¨ë“  í…Œì´ë¸”ì„ ìƒì„±í•©ë‹ˆë‹¤.
            await conn.run_sync(Base.metadata.create_all)
        print("INFO: DB í…Œì´ë¸” ìƒì„± í™•ì¸ ì™„ë£Œ.")
    except Exception as e:
        print(f"FATAL ERROR: DB í…Œì´ë¸” ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        return

    print("--- ğŸš€ ë³´ì¡°ê¸ˆ ë°ì´í„° ì´ˆê¸°í™” ì‹œì‘ ---")

    # 1. ê¸°ì¡´ ë°ì´í„° ì‚­ì œ (ì¬ì‹¤í–‰ì„ ìœ„í•´)
    async with AsyncSessionLocal() as session:
        try:
            print("INFO: ê¸°ì¡´ Subsidy ë°ì´í„° ì‚­ì œ ì¤‘...")
            await session.execute(Subsidy.__table__.delete())
            await session.commit()
            print("INFO: ê¸°ì¡´ ë°ì´í„° ì‚­ì œ ì™„ë£Œ.")
        except Exception as e:
            await session.rollback()
            print(f"ERROR: ë°ì´í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            return

    # 2. ìƒˆë¡œìš´ ë°ì´í„° ê°ì²´ ìƒì„± ë° ë²Œí¬ ì‚½ì…
    subsidy_objects = []

    # âš ï¸ ì¤‘ìš”: CSV ë°ì´í„°ë¥¼ íŒŒì‹±í•˜ì—¬ ëª¨ë¸ ê·¸ë£¹ì„ ì¶”ì¶œí•©ë‹ˆë‹¤.
    for manufacturer, model_name, national, local, total in RAW_SUBSIDY_DATA:
        # ëª¨ë¸ ê·¸ë£¹ ì¶”ì¶œ ë¡œì§
        model_group = extract_model_group(model_name)

        # ëª¨ë¸ ê·¸ë£¹ ì¶”ì¶œì´ ì˜ˆìƒê³¼ ë‹¤ë¥´ê²Œ ì‘ë™í•˜ëŠ” ê²½ìš° ë””ë²„ê¹…ìš© ë¡œê·¸
        # print(f"Raw: {model_name} -> Group: {model_group}")

        subsidy_objects.append(
            Subsidy(
                manufacturer=manufacturer,
                model_group=model_group,
                model_name=model_name,
                subsidy_national_10k_won=national,
                subsidy_local_10k_won=local,
                subsidy_total_10k_won=total,
            )
        )

    async with AsyncSessionLocal() as session:
        try:
            print(f"INFO: {len(subsidy_objects)}ê°œì˜ ë³´ì¡°ê¸ˆ ë°ì´í„° ì‚½ì… ì¤‘...")

            # bulk_save_objectsë¥¼ ì‚¬ìš©í•˜ì—¬ íš¨ìœ¨ì ìœ¼ë¡œ ì‚½ì…
            session.bulk_save_objects(subsidy_objects)
            await session.commit()

            print("SUCCESS: ë³´ì¡°ê¸ˆ ì´ˆê¸° ë°ì´í„° ì‚½ì… ì™„ë£Œ!")
        except Exception as e:
            await session.rollback()
            print(f"FATAL ERROR: ë°ì´í„° ì‚½ì… ì¤‘ ì¹˜ëª…ì ì¸ ì˜¤ë¥˜ ë°œìƒ: {e}")

if __name__ == "__main__":
    # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
    asyncio.run(initialize_subsidy_data())