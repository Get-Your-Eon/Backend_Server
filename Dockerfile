# ------------------------------------------------------
# Base Image
# ------------------------------------------------------
FROM python:3.12-slim

# 작업 디렉토리 설정
WORKDIR /app

# ------------------------------------------------------
# (선택적) 시스템 빌드 도구 설치
# Shapely 같은 C 확장 모듈이 필요할 때만 사용
# python:3.12-slim 이미지에는 기본적으로 빌드 툴이 없습니다.
# 필요 시 주석 해제하세요.
# ------------------------------------------------------
# RUN apt-get update && apt-get install -y --no-install-recommends \
#     gcc \
#     musl-dev \
#     geos-dev \
#     && rm -rf /var/lib/apt/lists/*

# ------------------------------------------------------
# Poetry 설치
# ------------------------------------------------------
RUN pip install poetry

# Poetry export 플러그인 설치
RUN poetry self add poetry-plugin-export

# ------------------------------------------------------
# 프로젝트 의존성 파일 복사
# ------------------------------------------------------
COPY pyproject.toml poetry.lock /app/

# ------------------------------------------------------
# Poetry → requirements.txt로 변환
# shapely 등 모든 main dependencies 포함
# ------------------------------------------------------
RUN poetry export -f requirements.txt --output requirements.txt --without-hashes --only main

# ------------------------------------------------------
# Python 의존성 설치
# uvicorn[standard]도 함께 설치
# ------------------------------------------------------
RUN pip install -r requirements.txt && pip install "uvicorn[standard]"

# ------------------------------------------------------
# 앱 전체 복사
# ------------------------------------------------------
COPY . /app

# ------------------------------------------------------
# 포트 노출
# ------------------------------------------------------
EXPOSE 8000

# ------------------------------------------------------
# 서버 실행 명령
# ------------------------------------------------------
CMD ["/usr/local/bin/python", "-m", "uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
