server {
    listen 80;
    server_name _;

    # Swagger UI
    location /docs/ {
        auth_basic "Team Only";
        auth_basic_user_file /etc/nginx/.htpasswd;

        limit_except GET { deny all; }

        # /docs/ 요청을 /docs로 rewrite
        rewrite ^/docs/$ /docs break;

        proxy_pass http://ev_charger_api:8000/docs;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Redoc UI
    location /redoc/ {
        auth_basic "Team Only";
        auth_basic_user_file /etc/nginx/.htpasswd;

        limit_except GET { deny all; }

        rewrite ^/redoc/$ /redoc break;

        proxy_pass http://ev_charger_api:8000/redoc;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # FastAPI OpenAPI JSON
    location /openapi.json {
        auth_basic "Team Only";
        auth_basic_user_file /etc/nginx/.htpasswd;

        limit_except GET { deny all; }

        proxy_pass http://ev_charger_api:8000/openapi.json;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 나머지 접근 차단
    location / {
        return 403;
    }
}
